'use client'

import { useState, useEffect } from 'react'
import { useParams } from 'next/navigation'
import Link from 'next/link'
import { getResult } from '@/lib/api'
import { Pie } from 'react-chartjs-2'
import {
  Chart as ChartJS,
  ArcElement,
  Tooltip,
  Legend,
  Title
} from 'chart.js'
import styles from './page.module.css'

ChartJS.register(ArcElement, Tooltip, Legend, Title)

interface ResultData {
  test: { slug: string; title: string }
  computed_at: string
  dimensions: Array<{
    code: string
    title: string
    score: number
    level: string
  }>
  summary_md: string
  viz: {
    type: string
    data: {
      labels: string[]
      values: number[]
    }
  }
  actions: {
    can_copy_link: boolean
    restart_url: string
    result_url?: string
  }
}

const STYLE_CONFIG = {
  'ИНФОРМИРОВАНИЕ': {
    color: '#D94A3C',
    title: 'ИНФОРМИРОВАНИЕ',
    summary: `
      <p>Ваш результат: <strong>Директивный стиль руководства</strong> <br/><em>У вас ярко выражен <span>директивный</span> (инструктирующий) стиль руководства.</em></p></br>
      <p>Вы склонны самостоятельно определять цели и пути их достижения, чётко формулируете задачи и требуете их исполнения в соответствии с установленными стандартами.</p></br>
      <p>Для вас важно, чтобы сотрудники точно понимали, что, как и когда нужно сделать. Вы предпочитаете держать процесс под контролем, обеспечивая выполнение работы по шагам и минимизируя неопределённость.</p>
    `,
    sections: [
      {
        title: 'Характеристика руководителя с директивным стилем',
        items: [
          'Ставит цели самостоятельно, максимально подробно, формулирует их по принципу SMART.',
          'Принимает решения по всем вопросам без обсуждения с подчиненными.',
          'Дает детальные инструкции — кто, что, когда и как должен сделать.',
          'Сам разрабатывает план работы или руководит планированием.',
          'Осуществляет пошаговый контроль и обеспечивает постоянную обратную связь по процессу.',
          'Степень поддержки сотрудников невысока, акцент делается на задаче и результате.',
          'Поощряет прогресс и выполнение, но не вовлекает подчиненных в процесс принятия решений.'
        ]
      },
      {
        title: 'Когда этот стиль наиболее эффективен',
        description: ['Директивный стиль наилучшим образом подходит для работы с сотрудниками уровня зрелости R1 — “Начинающий энтузиаст”, то есть: новыми или неопытными работниками, не обладающими необходимыми навыками для выполнения задач, но проявляющими высокий уровень мотивации и энтузиазма.',
                      'Таким сотрудникам нужны:'],
        items: [
          'четкие указания, стандарты и приоритеты,',
          'ясное понимание ролей и сроков,',
          'постоянное информирование и обратная связь о ходе выполнения.',
        ],
        conclusion: 'Руководитель в этой ситуации должен быть для них наставником, помогая освоить основы и не допустить ошибок.'
      },
      {
        title: 'Возможные риски при чрезмерной директивности',
        items: [
          'Сотрудники могут стать чрезмерно зависимыми от руководителя, не проявлять инициативу.',
          'Со временем чрезмерный контроль может снижать внутреннюю мотивацию и креативность.',
          'Если команда уже более опытна, такой подход может восприниматься как недоверие.'
        ]
      },
      {
        title: 'Рекомендации по развитию',
        items: [
          'Постепенно повышайте степень самостоятельности сотрудников, делегируйте не только задачи, но и часть решений.',
          'Сохраняйте четкость и структурность, но оставляйте пространство для инициативы.',
          'Развивайте навыки доверия, мотивации и поддержки — они помогут эффективнее управлять более зрелыми командами.'
        ]
      }
    ]
  },
  'ОБУЧЕНИЕ': {
    color: '#FFCF4A',
    title: 'ОБУЧЕНИЕ',
    summary: `
      <p>Ваш результат: <strong>Обучающий стиль руководства</strong><br/> <em>У вас ярко выражен <span>обучающий</span> (коучинговый) стиль руководства.</em></p></br>
      <p>Вы склонны сочетать высокую директивность с активной поддержкой. С одной стороны, вы ясно формулируете задачи и сохраняете ответственность за принятие решений. С другой — вовлекаете сотрудников в обсуждение, объясняете логику действий и помогаете им понять «почему» и «зачем» выполняется то или иное задание.</p></br>
      <p>Ваш подход направлен не просто на выполнение задачи, а на развитие подчиненных, формирование у них уверенности и компетенций.</p>
    `,
    sections: [
      {
        title: 'Характеристика руководителя с обучающим стилем',
        items: [
          'Сам ставит цели и принимает решения, но после обсуждения с сотрудниками.',
          'Активно объясняет причины действий, делится знаниями и опытом.',
          'Поддерживает диалог, задаёт развивающее вопросы ("А как бы ты поступил?", "Почему ты так считаешь?").',
          'Руководит процессом планирования, но учитывает предложения команды.',
          'Предоставляет обратную связь регулярно, направленную на процесс, а не только на результат.',
          'Высоко поддерживает сотрудников — поощряет идеи, вдохновляет, хвалит за успехи, помогает справиться с трудностями.',
          'При этом сохраняет четкость, последовательность и структурность в управлении.'
        ]
      },
      {
        title: 'Когда этот стиль наиболее эффективен',
        description: 'Обучающий стиль наиболее результативен при работе с сотрудниками уровня зрелости R2 — "Разочарованный ученик":',
        items: [
          'у них еще недостаточно знаний и навыков, но уже есть определённый опыт;',
          'мотивация часто снижается из-за первых ошибок и разочарования в сложности задач;',
          'они нуждаются в контроле, поддержке, поощрении и обратной связи;',
          'им важно понимать, почему что-то нужно делать именно так.',
        ],
        conclusion: 'В такой ситуации руководство должен проявлять терпение, помогать сотруднику восстанавливать уверенность, учить и направлять, не снижая при этом требований.'
      },
      {
        title: 'Возможные риски при чрезмерной обучающей позиции',
        items: [
          'Сотрудники могут начать чрезмерно зависеть от постоянных объяснений и поддержки.',
          'Перегрузка коммуникацией может замедлять процесс принятия решений.',
          'Если не переходить вовремя к более делегирующему поводу, сотрудник может застрять на уровне ученичества.'
        ]
      },
      {
        title: 'Рекомендации по развитию',
        items: [
          'Поздравляйте активно развивать способности сотрудникам через обсуждения, обратную связь и объяснение логики решений.',
          'Старайтесь поэтапно повышать уровень самостоятельности подчиненных, постепенно уменьшая директивность.',
          'Поддерживайте атмосферу доверия и открытого диалога, поощряйте инициативу.',
          'Развивайте в себе навыки коучинга и наставничества: задавайте вопросы, помогающие сотрудникам самим находить решения.'
        ]
      }
    ]
  },
  'ПОДДЕРЖКА': {
    color: '#29A80D',
    title: 'ПОДДЕРЖКА',
    summary: `
      <p>Ваш результат: <strong>Обучающий стиль руководства</strong><br/>
      <em>У вас выражен <span>поддерживающий</span> (совместный) стиль руководства.</em></p><br/>
      <p>Вы стремитесь к партнёрским отношениям с сотрудниками, активно вовлекаете их в процесс принятия решений, предоставляете свободу действий и одновременно поддерживаете морально</p><br/>
      <p>Ваша цель — укрепить уверенность подчиненных, мотивировать их к самостоятельности и развить чувство ответственности за результат.</p>
    `,
    sections: [
      {
        title: 'Характеристика руководителя с поддерживающим стилем',
        items: [
          'Совместно с сотрудником формирует цели и определяет задачи.',
          'Делегирует часть планирования и принятия решений, поощряя инициативу.',
          'Предоставляет всю необходимую информацию, помогает разобраться в организационных вопросах.',
          'Вовлекает сотрудников в процесс обсуждения, спрашивает их мнение и учитывает предложения.',
          'Поддерживает уверенность подчиненных, ободряет, помогает преодолевать сомнения.',
          'Осуществляет контроль по этапам (вехам), а не пошагово, фокусируясь на результате, а не на процессе.',
          'Обратная связь конструктивна, направлена на поддержание мотивации и повышение уверенности в своих силах.'
        ]
      },
      {
        title: 'Когда этот стиль наиболее эффективен',
        description: 'Поддерживающий стиль управления оптимален для работы с сотрудниками уровня зрелости R3 — “Осторожный исполнитель”, которые:',
        items: [
          'обладают знаниями и навыками для выполнения задач (средний или высокий уровень компетенции),',
          'могут работать самостоятельно, но не всегда уверены в себе,',
          'иногда проявляют колебания в принятии решений и нуждаются в одобрении,',
          'хотят быть услышанными, ценят поддержку и признание.',
        ],
        conclusion: 'Руководитель здесь играет роль наставника-партнера — помогает сотруднику поверить в свои силы, укрепить внутреннюю мотивацию и развить автономность.'
      },
      {
        title: 'Возможные риски при чрезмерной поддерживающей позиции',
        items: [
          'Сотрудники могут привыкнуть полагаться на эмоциональную поддержку и избегать полной ответственности.',
          'При избыточной вовлеченности руководителя принятие решений может замедляться.',
          'Если не вовремя перейти к делегирующему стилю, развитие самостоятельности сотрудников может застопориться.'
        ]
      },
      {
        title: 'Рекомендации по развитию',
        items: [
          'Продолжайте использовать диалоговый формат, поддерживая сотрудников и признавая их достижения.',
          'Постепенно передавайте им больше полномочий — от совместного планирования к самостоятельному.',
          'Сохраняйте открытость, но уменьшайте зависимость команды от вашего постоянного участия.',
          'Уделяйте внимание результату, а не только процессу: помогайте сотрудникам видеть влияние их решений.',
          'Развивайте доверие и уверенность — это естественный мост к следующему уровню лидерства — делегирующему стилю.'
        ]
      }
    ]
  },
  'ДЕЛЕГИРОВАНИЕ': {
    color: '#1E86EA',
    title: 'ДЕЛЕГИРОВАНИЕ',
    summary: `
      <p>Ваш результат: <strong>Обучающий стиль руководства</strong></p>
      <p><em>У вас слабо выражен <span>делегирующий</span> (доверительный) стиль руководства.</em></p><br/>
      <p>Вы доверяете сотрудникам, предоставляете им свободу действий и возможность самостоятельно принимать решения. Ваш подход основан на уверенности в профессионализме подчиненных: вы обозначаете цели и сроки, а ответственность за способы достижения результата передаете им.</p><br/>
      <p>Этот стиль демонстрирует зрелость руководителя, готовность отпустить избыточный контроль и выстраивать отношения на основе доверия и партнёрства.</p>
    `,
    sections: [
      {
        title: 'Характеристика руководителя с делегирующим стилем',
        items: [
          'Обозначает задачу и ожидаемые результаты, согласует сроки выполнения.',
          'Требует от сотрудника разработки решения и плана действий, при необходимости оказывает поддержку.',
          'Предоставляет информацию по запросу, не вмешивается без необходимости.',
          'Делегирует ответственность за выполнение задач и принятие решений.',
          'Контроль минимален, основан на итогах, а не на процессе.',
          'Обратная связь дается в основном по результату, с элементами совместного анализа и самооценки сотрудника.',
          'Поощряет самостоятельность, инициативу и готовность брать на себя сложные задачи.'
        ]
      },
      {
        title: 'Когда этот стиль наиболее эффективен',
        description: 'Делегирующий стиль подходит для сотрудников уровня зрелости R4 — “Уверенный профессионал”, которые:',
        items: [
          'имеют высокий уровень компетентности и устойчивую эффективность,',
          'мотивированы внутренне, гордятся своими результатами,',
          'предпочитают работать автономно и самостоятельно принимать решения,',
          'могут быть наставниками для других,',
          'нуждаются не в контроле, а в признании и доверии.'
        ],
        conclusion: 'Для таких сотрудников руководитель становится партнёром и стратегом, создающим условия для профессионального роста и самореализации.'
      },
      {
        title: 'Возможные риски при чрезмерной делегации',
        items: [
          'Сотрудники могут привыкнуть полагаться на эмоциональную поддержку и избегать полной ответственности.',
          'При избыточной вовлеченности руководителя принятие решений может замедляться.',
          'Если не вовремя перейти к делегирующему стилю, развитие самостоятельности сотрудников может застопориться.'
        ]
      },
      {
        title: 'Рекомендации по развитию',
        items: [
          'Поддерживайте баланс между доверием и вовлеченностью: контролируйте стратегические результаты, не вмешиваясь в детали.',
          'Регулярно обсуждайте итоги работы, помогайте видеть вклад сотрудника в общие цели.',
          'Используйте обратную связь как инструмент признания и развития, а не контроля.',
          'Предоставляйте сложные и разнообразные задачи, чтобы поддерживать интерес и мотивацию.',
          'Помните: делегирующий стиль наиболее эффективен, когда руководитель остается доступным и готов помочь, если это действительно нужно.'
        ]
      }
    ]
  }
}

export default function ResultPage() {
  const params = useParams()
  const [result, setResult] = useState<ResultData | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [openSections, setOpenSections] = useState<Record<number, boolean>>({})

  useEffect(() => {
    const fetchResult = async () => {
      try {
        const data = await getResult(params.uuid as string)
        setResult(data)
      } catch (err: any) {
        setError(`Не удалось загрузить результаты: ${err.message}`)
      } finally {
        setIsLoading(false)
      }
    }
    if (params.uuid) fetchResult()
  }, [params.uuid])

  if (isLoading) return <div className={styles.loading}>Загрузка...</div>
  if (error || !result)
    return (
      <div className={styles.error}>
        <h3>Ошибка</h3>
        <p>{error || 'Результаты не найдены'}</p>
      </div>
    )

  const maxScore = Math.max(...result.dimensions.map(d => d.score));
  const leaders = result.dimensions.filter(d => d.score === maxScore);

  const sortedScores = result.dimensions
    .map(d => d.score)
    .sort((a, b) => b - a);

  const hasClearLeader = true;

  if (!hasClearLeader || leaders.length > 1) {
    return (
      <div className={styles.retry}>
        <div className={styles.retryContainer}>
          <div className={styles.retryImage}>
            <div className={styles.sadImagePlaceholder}>Картинка грустная</div>
          </div>
          <div className={styles.retryContent}>
            <h1>Попробуйте еще раз</h1>
            <p>Результаты теста не позволяют однозначно определить ваш ведущий стиль руководства.</p>
            <p>Возможно, ваши ответы были слишком равномерными или противоречивыми, поэтому профиль получился неустойчивым.</p>
            <p>Попробуйте пройти тест ещё раз, выбирая оценки, которые лучше отражают ваши реальные предпочтения в разных ситуациях.</p>
            <Link href={result.actions.restart_url} className={styles.restartBtn}>
              Пройти заново
            </Link>
          </div>
        </div>
      </div>
    )
  }

  const main = leaders[0]
  const mainStyle = STYLE_CONFIG[main.code.toUpperCase() as keyof typeof STYLE_CONFIG]

  if (!mainStyle) {
    return (
      <div className={styles.error}>
        <h3>Ошибка</h3>
        <p>Неизвестный стиль руководства: {main.title}</p>
      </div>
    )
  }

  const chartData = {
    labels: result.viz.data.labels,
    datasets: [
      {
        data: result.viz.data.values,
        backgroundColor: [
          STYLE_CONFIG.ИНФОРМИРОВАНИЕ.color,
          STYLE_CONFIG.ОБУЧЕНИЕ.color,
          STYLE_CONFIG.ПОДДЕРЖКА.color,
          STYLE_CONFIG.ДЕЛЕГИРОВАНИЕ.color
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }
    ]
  }

  const chartOptions = {
    plugins: {
      legend: {
        position: 'bottom' as const,
        labels: {
          boxWidth: 20,
          padding: 15,
          usePointStyle: true,
          pointStyle: 'circle',
          font: {
            size: 12
          }
        }
      },
      title: { display: false },
      tooltip: {
        callbacks: {
          label: function(context: any) {
            const label = context.label || '';
            const value = context.raw || 0;
            return `${label}: ${value} баллов`;
          }
        }
      }
    },
    maintainAspectRatio: false,
    responsive: true,
    layout: {
    padding: {
      top: 0,
      bottom: -8
    }
  }

  }

  const toggleSection = (idx: number) => {
    setOpenSections(prev => ({ ...prev, [idx]: !prev[idx] }))
  }

  return (
    <div className={styles.container}>
      <div className={styles.topSection}>
        <div className={styles.chartContainer}>
          <div className={styles.chart}>
            <Pie data={chartData} options={chartOptions} height={400} width={400} />
          </div>
        </div>

        <div className={styles.summary}>
          <h1 className={styles.title} style={{ color: mainStyle.color }}>
            {mainStyle.title}
          </h1>
          <div
            className={styles.summaryContent}
            dangerouslySetInnerHTML={{
              __html: mainStyle.summary
              .replace(
                /<span>/g,
                `<span style="color: ${mainStyle.color}; font-weight: 600;">`
              )
              .replace(
                /<em>/g,
                `<em style="border-left: 3px solid ${mainStyle.color}; padding-left: 12px; margin-left: 2px; font-style: italic; display: inline-block;">`
              )
            }}
          />
        </div>
      </div>

      <div className={styles.sections}>
        {mainStyle.sections.map((section: any, idx: number) => (
          <div key={idx} className={styles.section}>
            <div
              className={styles.sectionHeader}
              onClick={() => toggleSection(idx)}
              style={{ borderLeftColor: mainStyle.color }}
            >
              <h2
                className={styles.sectionTitle}
                style={{ color: mainStyle.color }}
              >
                {section.title}
              </h2>
              <span
                className={styles.arrow}
                style={{ color: mainStyle.color }}
              >
                {openSections[idx] ? '▲' : '▼'}
              </span>
            </div>

            {openSections[idx] && (
              <div className={styles.sectionContent}>
                {section.description && (
                  <p className={styles.description}>{section.description}</p>
                )}

                {section.items && section.items.length > 0 && (
                  <ul className={styles.sectionList}>
                    {section.items.map((item: string, itemIdx: number) => (
                      <li key={itemIdx}>{item}</li>
                    ))}
                  </ul>
                )}

                {section.conclusion && (
                  <p className={styles.conclusion}>{section.conclusion}</p>
                )}
              </div>
            )}
          </div>
        ))}
      </div>

      <div className={styles.actions}>
        <button
          className={styles.saveBtn}
          onClick={() => {
            const currentUrl = window.location.href;
            navigator.clipboard.writeText(currentUrl);
            alert('Ссылка на результат скопирована в буфер обмена!');
          }}
        >
          Сохранить результат
        </button>
        <button
          className={styles.restartBtn}
          onClick={() => {
            window.location.href = result.actions.restart_url;
          }}
        >
          Пройти заново
        </button>
      </div>
    </div>
  )
}
